(function(){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/,"")};String.isNullOrEmpty=function(n){return!n||!n.length||!n.trim().length};String.isInteger=function(n){return/^\d+$/.test(n)};Date.prototype.toTime=function(){var n=this.getHours(),t=this.getMinutes(),i=this.getSeconds(),r=n<12;return n===0&&(n=12),n>12&&(n-=12),[n.toString(),t<10?":0":":",t.toString(),i<10?":0":":",i.toString(),r?" AM":" PM"].join("")};var n=function(){};n.prototype={endpoint:initPara.endpoint,user:initPara.user,xmlFactories:[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],categoriesLoaded:!1,editMode:null,editID:null,firstEdit:!1,generalAdminIdx:-1,errors:[],changes:[],broadcastID:null,accessToken:initPara.accessToken,refreshToken:null,__sendRequest:function(n,t,i,r,u,f,e,o){if(!e||!TimeKeep.ajaxLock){TimeKeep.ajaxLock=!0;var s=TimeKeep.getAjax();if(s)return s.open(t,n,r!==null),s.setRequestHeader("Accept","application/json"),s.setRequestHeader("X-Requested-With","XMLHttpRequest"),f&&s.setRequestHeader("Authorization","Bearer "+TimeKeep.accessToken),s.setRequestHeader("Content-Type","application/json;charset=UTF-8"),s.eCallback=u,s.sCallback=r,s.dCallback=o,s.onreadystatechange=function(){var n,t;if(this.readyState===4)if(TimeKeep.ajaxLock=!1,this.dCallback&&this.dCallback(),this.status>399&&this.eCallback){n=null;try{n=JSON.parse(this.responseText)}catch(i){}this.eCallback({ajax:this,data:n,status:this.status})}else if(this.sCallback){t=null;try{t=JSON.parse(this.responseText).Result}catch(i){}this.sCallback({ajax:this,data:t,status:this.status})}},s.send(i?JSON.stringify(i):""),r?void 0:{ajax:s,data:JSON.parse(this.responseText),status:s.status}}},lastDay:(new Date).getDate(),clock:function(){var n=function(){var i=new Date,t=i.getHours(),r=i.getMinutes(),u=i.getSeconds(),e=t<12,f;t>12?t-=12:t==0&&(t=12);r=(r<10?"0":"")+r.toString();u=(u<10?"0":"")+u.toString();f=[t,":",r,":",u,e?" AM":" PM"];document.getElementById("currentTime").innerHTML=f.join("");setTimeout(n,1e3);i.getDate()!==TimeKeep.lastDay&&(TimeKeep.endOfDay(),TimeKeep.lastDay=i.getDate())};n()},ajaxLock:!1,getUTCDateRange:function(){var n=new Date,t=new Date(n.getFullYear(),n.getMonth(),n.getDate(),0,0,0,0),i=new Date(n.getFullYear(),n.getMonth(),n.getDate()+1,0,0,0,0);return{Start:t.toISOString(),End:i.toISOString()}},getAjax:function(){for(var n=0;n<TimeKeep.xmlFactories.length;n++)try{return TimeKeep.xmlFactories[n]()}catch(t){continue}},getAPIURL:function(n){return TimeKeep.endpoint+n},sendRequest:function(n,t,i,r,u,f,e){return TimeKeep.__sendRequest(TimeKeep.getAPIURL(n),t,i,r,u,!0,f,e)},sendLocalRequest:function(n,t,i,r,u,f,e){return TimeKeep.__sendRequest(n,t,i,r,u,!1,f,e)},btnStartYourDate:function(){var n={ID:null,User:TimeKeep.user};TimeKeep.sendRequest("/timekeepentries","POST",n,function(n){var t,i;n&&n.data&&(n.data.Modified&&(t={changeType:"Modified",data:n.data.Modified},TimeKeep.broadcastChange(t),TimeKeep.changes.push(t)),i={changeType:"Added",data:n.data.New},TimeKeep.changes.push(i),TimeKeep.broadcastChange(i),TimeKeep.editMode=null,TimeKeep.megaUpdate())},function(){},!0)},init:function(){TimeKeep.clock();TimeKeep.sendRequest("/timekeepentries/user/"+TimeKeep.user,"POST",TimeKeep.getUTCDateRange(),function(n){var t,i;if(n&&n.data){for(document.getElementById(n.data.length?"entries":"noentries").style.display="",t=document.getElementById("mainloading"),t.parentElement.removeChild(t),t=null,i=0;i<n.data.length;i++)TimeKeep.changes.push({changeType:"Added",data:n.data[i]});TimeKeep.processChanges()}},function(){});TimeKeep.sendRequest("/categories","GET",null,function(n){var e,t,o,f;if(n&&n.data&&n.data.length){var i=[],r=[],u=[];for(e=0;e<n.data.length;e++)t=n.data[e],t.IsOut?(u.push('<option value="'),u.push(t.ID.toString()),u.push('">'),u.push(t.Description),u.push("<\/option>")):t.IsScorecard?(i.push('<option value="'),i.push(t.ID.toString()),i.push('">'),i.push(t.Description),i.push("<\/option>")):(r.push('<option value="'),r.push(t.ID.toString()),r.push('">'),r.push(t.Description),r.push("<\/option>"));for(document.getElementById("CategoryScorecard").innerHTML=i.join(""),document.getElementById("CategoryNonscorecard").innerHTML=r.join(""),document.getElementById("CategoryOut").innerHTML=u.join(""),o=document.getElementById("CategoryNonscorecard").parentElement.options,f=0;f<o.length;f++)if(o[f].innerHTML==="General Administration"){TimeKeep.generalAdminIdx=f;break}document.getElementById("CategoryNonscorecard").parentElement.options[TimeKeep.generalAdminIdx].selected=!0;TimeKeep.categoriesLoaded=!0;TimeKeep.megaUpdate()}},function(){});TimeKeep.sendLocalRequest("/broadcast/register","POST",{User:TimeKeep.user},function(n){n&&n.data&&(TimeKeep.broadcastID=n.data.ID,TimeKeep.startBroadcastListener())},function(){})},broadcastChange:function(n){TimeKeep.sendLocalRequest("/broadcast/broadcast","POST",{ID:TimeKeep.broadcastID,Change:n},function(){},function(){})},startBroadcastListener:function(){var n=function(){TimeKeep.sendLocalRequest("/broadcast/changes","POST",{ID:TimeKeep.broadcastID},function(t){var i,r;if(t&&(i=t.data,i&&i.length)){for(r=0;r<i.length;r++)TimeKeep.changes.push(i[r]);TimeKeep.processChanges()}setTimeout(n,5e3)},function(){setTimeout(n,5e3)})},t=function(){TimeKeep.sendLocalRequest("/broadcast/deregister","POST",{ID:TimeKeep.broadcastID},function(){},function(){})};window.onbeforeunload=t;setTimeout(n,3e3)},btnCancelClick:function(){document.getElementById("StartTimeHH").selectedIndex=0;document.getElementById("StartTimeMM").selectedIndex=0;document.getElementById("StartTimeSS").selectedIndex=0;document.getElementById("StartTimeAM").selectedIndex=0;document.getElementById("EndTimeHH").selectedIndex=0;document.getElementById("EndTimeMM").selectedIndex=0;document.getElementById("EndTimeSS").selectedIndex=0;document.getElementById("EndTimeAM").selectedIndex=0;document.getElementById("EndTimeAM").selectedIndex=0;document.getElementById("Category").selectedIndex=0;document.getElementById("CaseNumber").value="";TimeKeep.editMode=null;TimeKeep.megaUpdate()},btnSaveClick:function(){var u,f;document.getElementById("btnSave").innerHTML="Saving...";document.getElementById("btnSave").disabled=!0;document.getElementById("btnCancel").disabled=!0;var t=[],i=parseInt(document.getElementById("StartTimeHH").value,10),a=parseInt(document.getElementById("StartTimeMM").value,10),v=parseInt(document.getElementById("StartTimeSS").value,10),o=document.getElementById("StartTimeAM").value==="AM";i===12&&o?i=0:!o&&i<12&&(i+=12);var r=parseInt(document.getElementById("EndTimeHH").value,10),y=parseInt(document.getElementById("EndTimeMM").value,10),p=parseInt(document.getElementById("EndTimeSS").value,10),s=document.getElementById("EndTimeAM").value==="AM";r===12&&s?r=0:!s&&r<12&&(r+=12);var n=new Date,h=new Date(n.getFullYear(),n.getMonth(),n.getDate(),i,a,v,0),c=new Date(n.getFullYear(),n.getMonth(),n.getDate(),r,y,p,0),e=document.getElementById("Category"),l=e.options[document.getElementById("Category").selectedIndex].parentNode.id==="CategoryScorecard",w=e.options[document.getElementById("Category").selectedIndex].parentNode.id==="CategoryOut",b=e.options[document.getElementById("Category").selectedIndex].innerHTML;TimeKeep.editMode==="E"&&c<=h&&t.push("The end time must take place after the start time");(TimeKeep.editMode==="A"||TimeKeep.editMode==="E")&&l&&(String.isNullOrEmpty(document.getElementById("CaseNumber").value)?t.push("The case number is required if the labor is a scorecard labor"):String.isInteger(document.getElementById("CaseNumber").value.trim())||t.push("The case number must be an integer"));t.length?(TimeKeep.errors=t,TimeKeep.megaUpdate()):(TimeKeep.errors=[],TimeKeep.megaUpdate(),u={ID:TimeKeep.editID,User:TimeKeep.user,Category:{ID:document.getElementById("Category").value,Description:b,IsScorecard:l,IsOut:w},CaseNumber:document.getElementById("CaseNumber").value.trim(),StartTime:h.toISOString(),EndTime:c.toISOString()},f=function(){setTimeout(function(){document.getElementById("btnSave").disabled=!1;document.getElementById("btnCancel").disabled=!1;document.getElementById("btnSave").innerHTML="Save"},500)},TimeKeep.editMode==="A"?TimeKeep.sendRequest("/timekeepentries","POST",u,function(n){var t,i;n&&n.data&&(n.data.Modified&&(t={changeType:"Modified",data:n.data.Modified},TimeKeep.broadcastChange(t),TimeKeep.changes.push(t)),i={changeType:"Added",data:n.data.New},TimeKeep.changes.push(i),TimeKeep.broadcastChange(i),TimeKeep.editMode=null,TimeKeep.megaUpdate())},function(){},!0,f):TimeKeep.editMode==="E"?TimeKeep.sendRequest("/timekeepentries","PUT",u,function(n){if(n&&n.data){var t={changeType:"Modified",data:n.data};TimeKeep.changes.push(t);TimeKeep.broadcastChange(t);TimeKeep.editMode=null;TimeKeep.editID=null;TimeKeep.megaUpdate()}},function(){},!0,f):TimeKeep.editMode==="D"&&TimeKeep.sendRequest("/timekeepentries","DELETE",u,function(n){if(n&&n.data){var t={changeType:"Deleted",data:n.data};TimeKeep.changes.push(t);TimeKeep.broadcastChange(t);TimeKeep.editMode=null;TimeKeep.editID=null;TimeKeep.megaUpdate()}},function(){},!0,f))},btnLogClick:function(n){this.btnCloseSummaryClick();var t=n.parentElement.parentElement.id,i=["/timekeepentries/",t,"/toggle/islogged"].join("");TimeKeep.sendRequest(i,"PATCH",null,function(n){if(n&&n.data){var t={changeType:"Modified",data:n.data};TimeKeep.changes.push(t);TimeKeep.broadcastChange(t);TimeKeep.processChanges()}},function(){})},btnDetailClick:function(n){this.btnCloseSummaryClick();var t=n.parentElement.parentElement.id,i=["/timekeepentries/",t,"/toggle/isdetailed"].join("");TimeKeep.sendRequest(i,"PATCH",null,function(n){if(n&&n.data){var t={changeType:"Modified",data:n.data};TimeKeep.changes.push(t);TimeKeep.broadcastChange(t);TimeKeep.processChanges()}},function(){})},btnNewClick:function(n){this.btnCloseSummaryClick();TimeKeep.editMode="A";TimeKeep.firstEdit=!0;TimeKeep.editID=n.parentNode.parentNode.id;TimeKeep.megaUpdate()},btnEditClick:function(n){this.btnCloseSummaryClick();TimeKeep.editMode="E";TimeKeep.editID=n.parentNode.parentNode.id;TimeKeep.firstEdit=!0;TimeKeep.megaUpdate()},btnDeleteClick:function(n){this.btnCloseSummaryClick();TimeKeep.editMode="D";TimeKeep.editID=n.parentNode.parentNode.id;TimeKeep.megaUpdate()},btnSummaryClick:function(n){var t=document.getElementById(n.parentNode.parentNode.id).data.CaseNumber;document.getElementById("tbodySummary").innerHTML='<tr><td colspan="4">Loading...<\/td><\/tr>';document.getElementById("divCaseSummary").currentCase=t;TimeKeep.sendRequest("/timekeepentries/case/"+t+"/totals","POST",TimeKeep.getUTCDateRange(),function(n){n&&n.data&&(document.getElementById("spanTotalLabor").innerHTML=n.data,document.getElementById("divCaseSummary").style.display="",TimeKeep.sendRequest("/timekeepentries/case/"+t,"POST",TimeKeep.getUTCDateRange(),function(n){var t,r,i;if(n&&n.data){for(t=[],t.push("<tr>"),r=0;r<n.data.length;r++)i=n.data[r],t.push("<td>"),i.StartTime&&t.push(new Date(i.StartTime).toTime()),t.push("<\/td>"),t.push("<td>"),i.EndTime&&t.push(new Date(i.EndTime).toTime()),t.push("<\/td>"),t.push("<td>"),i.Category&&t.push(i.Category.Description),t.push("<\/td>"),t.push("<td>"),t.push(i.Labor),t.push("<\/td>"),t.push("<\/tr>");document.getElementById("tbodySummary").innerHTML=t.join("")}},function(){},!0))},function(){},!0)},btnLogAndDetailAllClick:function(){var n=document.getElementById("divCaseSummary").currentCase,t;document.getElementById("btnLogAndDetailAll").disabled=!0;document.getElementById("btnLogAndDetailAll").innerHTML="Saving...";t=function(){setTimeout(function(){document.getElementById("btnLogAndDetailAll").disabled=!1;document.getElementById("btnLogAndDetailAll").innerHTML="Log and detail all entries"},599)};n&&n.length&&TimeKeep.sendRequest("/timekeepentries/case/"+n+"/LogAndDetailAll","PUT",TimeKeep.getUTCDateRange(),function(n){var t,i;if(document.getElementById("divCaseSummary").style.display="none",n&&n.data){for(t=0;t<n.data.length;t++)i={changeType:"Modified",data:n.data[t]},TimeKeep.broadcastChange(i),TimeKeep.changes.push(i);TimeKeep.processChanges()}},function(){},!0,t)},btnCloseSummaryClick:function(){document.getElementById("divCaseSummary").style.display="none"},createRow:function(n){var t=document.createElement("tr");return t.id=n.ID,n.Category&&n.Category.IsScorecard&&(t.className=n.IsLogged||n.IsDetailed?n.IsLogged!==n.IsDetailed?"entry_yellow":"entry_green":"entry_red"),t.innerHTML=TimeKeep.createRowCells(n),t.data=n,t},createRowCells:function(n){var t=[];return t.push("<td>"),n.StartTime&&t.push(new Date(n.StartTime).toTime()),t.push("<\/td>"),t.push("<td>"),n.EndTime&&t.push(new Date(n.EndTime).toTime()),t.push("<\/td>"),n.Category?(t.push('<td id="'),t.push(n.Category.ID),t.push('">'),t.push(n.Category.Description)):t.push("<td>"),t.push("<\/td>"),n.CaseNumber&&n.CaseNumber?(t.push("<td>"),t.push(n.CaseNumber),t.push("<\/td>")):t.push("<td><\/td>"),t.push("<td>"),t.push(n.Labor),t.push("<\/td>"),t.push("<td>"),t.push(n.IsLogged?"Yes":"No"),t.push("<\/td>"),t.push("<td>"),t.push(n.IsDetailed?"Yes":"No"),t.push("<\/td>"),t.push("<td>"),n.EndTime?(t.push('<button onclick="TimeKeep.btnLogClick(this);">'),t.push(n.IsLogged?"Unlog":"Log"),t.push("<\/button>"),t.push(' <button onclick="TimeKeep.btnDetailClick(this);">'),t.push(n.IsDetailed?"Undetail":"Detail"),t.push("<\/button>"),t.push(' <button onclick="TimeKeep.btnEditClick(this);">Edit<\/button>'),t.push(' <button onclick="TimeKeep.btnDeleteClick(this);">Delete<\/button>'),t.push(' <button onclick="TimeKeep.btnSummaryClick(this);">Summary<\/button>')):t.push(' <button onclick="TimeKeep.btnNewClick(this);" class="stopnlog">Stop and Log<\/button>'),t.push("<\/td>"),t.join("")},megaUpdate:function(){var t,r,e;if(TimeKeep.editMode){if(TimeKeep.editMode==="A")document.getElementById("StartTimeHH").parentNode.style.display="none",document.getElementById("EndTimeHH").parentNode.style.display="none",document.getElementById("Category").parentNode.style.display="",document.getElementById("CaseNumber").parentNode.style.display="",document.getElementById("popupheader").innerHTML="Stop and Log",document.getElementById("caption").innerHTML="Before starting a new entry, please enter the information for your previous entry.",document.getElementById("btnSave").innerHTML="Save",TimeKeep.firstEdit&&(document.getElementById("StartTimeHH").selectedIndex=0,document.getElementById("StartTimeMM").selectedIndex=0,document.getElementById("StartTimeSS").selectedIndex=0,document.getElementById("StartTimeAM").selectedIndex=0,document.getElementById("EndTimeHH").selectedIndex=0,document.getElementById("EndTimeMM").selectedIndex=0,document.getElementById("EndTimeSS").selectedIndex=0,document.getElementById("EndTimeAM").selectedIndex=0,document.getElementById("Category").options[TimeKeep.generalAdminIdx].selected=!0,document.getElementById("CaseNumber").value="",TimeKeep.firstEdit=!1);else if(TimeKeep.editMode==="E"){if(document.getElementById("StartTimeHH").parentNode.style.display="",document.getElementById("EndTimeHH").parentNode.style.display="",document.getElementById("Category").parentNode.style.display="",document.getElementById("CaseNumber").parentNode.style.display="",document.getElementById("popupheader").innerHTML="Edit Entry",document.getElementById("caption").innerHTML="You are modifying an existing entry.",document.getElementById("btnSave").innerHTML="Save",TimeKeep.firstEdit){var i=document.getElementById(TimeKeep.editID).data,u=new Date(Date.parse(i.StartTime)),f=new Date(Date.parse(i.EndTime)),n=u.getHours();document.getElementById("StartTimeAM").value=n>=0&&n<12?"AM":"PM";document.getElementById("StartTimeMM").value=u.getMinutes();document.getElementById("StartTimeSS").value=u.getSeconds();n===0?n=12:n>12&&(n-=12);document.getElementById("StartTimeHH").value=n;n=f.getHours();document.getElementById("EndTimeAM").value=n>=0&&n<12?"AM":"PM";document.getElementById("EndTimeMM").value=f.getMinutes();document.getElementById("EndTimeSS").value=f.getSeconds();n===0?n=12:n>12&&(n-=12);document.getElementById("EndTimeHH").value=n;document.getElementById("Category").value=i.Category.ID;document.getElementById("CaseNumber").value=i.CaseNumber;TimeKeep.firstEdit=!1}}else TimeKeep.editMode==="D"&&(document.getElementById("StartTimeHH").parentNode.style.display="none",document.getElementById("EndTimeHH").parentNode.style.display="none",document.getElementById("Category").parentNode.style.display="none",document.getElementById("CaseNumber").parentNode.style.display="none",document.getElementById("popupheader").innerHTML="Delete Entry",document.getElementById("caption").innerHTML="Are you sure you want to delete this entry?",document.getElementById("btnSave").innerHTML="Delete");if(document.getElementById("popup").style.display="",document.getElementById("btnSYD").disabled=!0,TimeKeep.errors&&TimeKeep.errors.length){for(t=[],r=0;r<TimeKeep.errors.length;r++)t.push("<li>"),t.push(TimeKeep.errors[r]),t.push("<\/li>");document.getElementById("errorList").innerHTML=t.join("");t=null;document.getElementById("errors").style.display=""}else document.getElementById("errors").style.display="none"}else document.getElementById("errors").style.display="none",document.getElementById("popup").style.display="none",document.getElementById("btnSYD").disabled=!1;document.getElementById("popup").style.display=TimeKeep.editMode?"":"none";e=document.getElementById("Category").options[document.getElementById("Category").selectedIndex].parentNode.id;e==="CategoryScorecard"?document.getElementById("CaseNumber").disabled=!1:(document.getElementById("CaseNumber").disabled=!0,document.getElementById("CaseNumber").value="");TimeKeep.categoriesLoaded&&(document.getElementById("btnSave").disabled=!1);TimeKeep.processChanges()},processChanges:function(){if(TimeKeep.changes&&TimeKeep.changes.length){while(TimeKeep.changes.length){var n=TimeKeep.changes.shift(),t=null;n.changeType==="Modified"?(document.getElementById("noentries").style.display!=="none"&&(document.getElementById("noentries").style.display="none",document.getElementById("entries").style.display=""),t=document.getElementById(n.data.ID),newRow=TimeKeep.createRow(n.data),t.parentNode.insertBefore(newRow,t),t.parentNode.removeChild(t)):n.changeType==="Deleted"?(t=document.getElementById(n.data.ID),t.parentNode.removeChild(t)):n.changeType==="Added"?(document.getElementById("tbEntries").length||(document.getElementById("noentries").style.display="none",document.getElementById("entries").style.display=""),document.getElementById("tbEntries").appendChild(TimeKeep.createRow(n.data))):n.changeType==="EndOfDay"&&(document.getElementById("tbEntries").innerHTML="",document.getElementById("entries").style.display="none",document.getElementById("noentries").style.display="")}TimeKeep.updateTotals()}},updateTotals:function(){TimeKeep.sendRequest("/timekeepentries/user/"+TimeKeep.user+"/totals","POST",TimeKeep.getUTCDateRange(),function(n){var t,i,r;if(n&&n.data&&n.data.length){for(t=[],i=0;i<n.data.length;i++)r=n.data[i],i>0&&t.push("&nbsp;&nbsp;&nbsp;"),t.push("<span>"),t.push(r.Category.Description),t.push(": "),t.push(r.Labor),t.push("<\/span>");document.getElementById("tdtotals").innerHTML=t.join("")}},function(){})},endOfDay:function(){TimeKeep.changes=[];var n={data:null,changeType:"EndOfDay"};TimeKeep.broadcastChange(n);TimeKeep.changes.push(n)}};initPara=null;window.TimeKeep=new n})();